name: Update Homebrew Formula

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  update-formula:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0

      - name: Update Homebrew Formula
        run: |
          VERSION=$(echo $GITHUB_REF | sed 's/refs\/tags\///')
          SHA256=$(curl -sL https://github.com/JianZcar/FuzPad/releases/download/$VERSION/fuzpad-$VERSION.tar.gz | sha256sum | awk '{print $1}')
          
          cat > .formula/fuzpad.rb <<EOF
          class Fuzpad < Formula
            desc "Minimalistic note management solution. Powered by fzf"
            homepage "https://github.com/JianZcar/FuzPad"
            url "https://github.com/JianZcar/FuzPad/releases/download/$VERSION/fuzpad-$VERSION.tar.gz"
            sha256 "$SHA256"
            license "GPL-3.0-or-later"

            livecheck do
              url :stable
              strategy :github_latest
            end

            depends_on "bat"
            depends_on "fzf"

            def install
              bin.install "bin/fuzpad"
            end

            test do
              assert_equal "1", shell_output("#{bin}/fuzpad --test 2>&1 | grep -q \"1\" && echo 1 || echo 0").strip
            end
          end
          EOF

      - name: Commit changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .formula/fuzpad.rb
          git commit -m "Update Homebrew formula for version $VERSION"
          git push

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.TOKEN }}
          commit-message: "Update Homebrew formula for version $VERSION"
          title: "Update Homebrew formula for version $VERSION"
          body: "This PR updates the Homebrew formula for the new release version $VERSION."
          branch: "update-homebrew-formula-$VERSION"
