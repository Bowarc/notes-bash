name: Update Homebrew Formula

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  update-formula:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install GitHub CLI
        run: |
          npm install -g @githubnext/github

      - name: Get latest release tag
        id: get_latest_release
        run: |
          latest_release=$(gh release view --json tagName --jq '.tagName')
          echo "Latest release tag: $latest_release"
          echo "tag=$latest_release" >> $GITHUB_ENV

      - name: Update Homebrew Formula
        run: |
          SHA256=$(curl -sL https://github.com/JianZcar/FuzPad/releases/download/${{ env.tag }}/fuzpad-${{ env.tag }}.tar.gz | sha256sum | awk '{print $1}')
          
          cat > .formula/fuzpad.rb <<EOF
          class Fuzpad < Formula
            desc "Minimalistic note management solution. Powered by fzf"
            homepage "https://github.com/JianZcar/FuzPad"
            url "https://github.com/JianZcar/FuzPad/releases/download/${{ env.tag }}/fuzpad-${{ env.tag }}.tar.gz"
            sha256 "$SHA256"
            license "GPL-3.0-or-later"

            livecheck do
              url :stable
              strategy :github_latest
            end

            depends_on "bat"
            depends_on "fzf"

            def install
              bin.install "bin/fuzpad"
            end

            test do
              assert_equal "1", shell_output("#{bin}/fuzpad --test 2>&1 | grep -q \"1\" && echo 1 || echo 0").strip
            end
          end
          EOF

      - name: Commit changes
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .formula/fuzpad.rb
          git commit -m "Update Homebrew formula for version ${{ env.tag }}"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:main
