#!/bin/bash

# Set the SHELL environment variable, fixes POSIX-incompatible shells
SHELL=/bin/bash

# Default directory to scan (change to your default directory if needed).
FUZPAD_DIR="${FUZPAD_DIR:-"$HOME/Documents/.notes"}"
TEXT_FORMAT="${FUZPAD_TEXT_FORMAT:-"txt"}"
EDITOR="${EDITOR:-"nano"}"
DATE_TIME_FORMAT="${FUZPAD_DATE_TIME_FORMAT:-"%Y-%m-%d-%H-%M-%S"}"
BAT_THEME="${FUZPAD_BAT_THEME:-"OneHalfLight"}"

# Only applies to open and delete (default is false)
REVERSE_LIST=${FUZPAD_REVERSE_LIST:-"false"}
# 'T@' or 'W' for creation date, 'Y' for modified date (default is W)
SORT_FORMAT=${FUZPAD_SORT_FORMAT:-"T@"}

PREVIEW_SIZE=${FUZPAD_PREVIEW_SIZE:-"70%"}
# Recommend 5 for start_line so user can see the highlighted line quickly in the search preview
START_LINE_SEARCH_PREVIEW=${FUZPAD_START_LINE_SEARCH_PREVIEW:-"5"}
END_LINE_SEARCH_PREVIEW=${FUZPAD_END_LINE_SEARCH_PREVIEW:-"9999"}

get_current_date_time() {
	echo $(date +"$DATE_TIME_FORMAT")
}

# Creates FUZZPAD_DIR if it does not exist.
if [[ ! -d "$FUZPAD_DIR" ]]; then
	mkdir -p "$FUZPAD_DIR" &&
	cd "$FUZPAD_DIR"
fi

auto_git_commit(){
	cd "$FUZPAD_DIR" || return 1
	if [[ -d "$FUZPAD_DIR/.git" ]]; then
		git ls-files --others | grep -v '^$' | xargs git add > /dev/null 2>&1
		git commit -am "$(get_current_date_time)" > /dev/null 2>&1
	else
		git init > /dev/null 2>&1
		git ls-files --others | grep -v '^$' | xargs git add > /dev/null 2>&1
		git commit -am "$(get_current_date_time)" > /dev/null 2>&1
	fi
}

trap "exit" SIGINT SIGTERM

show_menu() {
	ACTIONS=("New" "Open" "Search" "Delete" "Quit")
	while true; do
		auto_git_commit &
		SELECTED_ACTION=$(printf "%s\n" "${ACTIONS[@]}" | fzf --border --layout=reverse --prompt="Choose an action: ")
		if [[ $? != 0 ]]; then
			break
		fi
		case $SELECTED_ACTION in
			"New")
				create_new_note
				;;
			"Open")
				open_note
				;;
			"Search")
				search_notes
				;;
			"Delete")
				delete_notes
				;;
			"Quit")
				break
				;;
			*)
				echo "Invalid action"
				;;
		esac
	done
}

list_order() {
  if [ ! "$REVERSE_LIST" = true ]; then
    echo "--tac"
  else
    echo ""
  fi
}

create_new_note(){
	cd "$FUZPAD_DIR"
	${EDITOR} "./$(get_current_date_time).$TEXT_FORMAT"
}

open_note(){
	NOTE=$(find "$FUZPAD_DIR" -type f -name "*.$TEXT_FORMAT" -exec stat --format="%$SORT_FORMAT %n" {} \; | sort -n | cut -d ' ' -f2- | xargs -I {} basename {} | fzf --border \
	--layout=reverse $(list_order) \
	--ignore-case --prompt="Open: " \
	--preview-window=down:$PREVIEW_SIZE:noinfo:wrap --preview="bat --color=always --theme=$BAT_THEME --style=plain $FUZPAD_DIR/{}")

	if [[ -n "$NOTE" ]]; then
		cd "$FUZPAD_DIR"
		${EDITOR} "./$NOTE"
		
	fi
}

delete_notes(){
	FUZPAD=$(find "$FUZPAD_DIR" -type f -name "*.$TEXT_FORMAT" -exec stat --format="%$SORT_FORMAT %n" {} \; | sort -n | cut -d ' ' -f2- | xargs -I {} basename {} | fzf --border \
	--layout=reverse $(list_order) \
	--multi --ignore-case --prompt="Delete: " \
	--preview-window=down:$PREVIEW_SIZE:noinfo:wrap --preview="bat --color=always --theme=$BAT_THEME --style=plain $FUZPAD_DIR/{}")

	if [[ -n "$FUZPAD" ]]; then
		CONFIRMATION=$(printf "%s\n" "$FUZPAD" | while read -r file; do stat --format="%$SORT_FORMAT %n" "$FUZPAD_DIR/$file"; done | sort -n | cut -d ' ' -f2- | xargs -I {} basename {} | \
		fzf --print-query --border \
		--layout=reverse $(list_order) \
		--disabled --prompt="Type 'yes' to confirm: " \
		--preview-window=down:$PREVIEW_SIZE:noinfo:wrap --preview="bat --color=always --theme=$BAT_THEME --style=plain $FUZPAD_DIR/{}" | head -n 1)

		if [[ "$CONFIRMATION" =~ ^[Yy][Ee][Ss]$ ]]; then
			cd "$FUZPAD_DIR"
			for NOTE in $FUZPAD; do
				rm "./$NOTE"
			done
		fi
	fi
}

search_notes(){
	SELECTED=$(echo "Enter your query to begin searching" | fzf --bind 'change:reload(
		if [[ -z {q} ]]; then
			echo "Enter your query to begin searching"
		else
			RESULTS=$(grep -rni --include="*."'$TEXT_FORMAT' {q} '$FUZPAD_DIR' 2> /dev/null)
			[ -n "$RESULTS" ] && echo "Found $(echo "$RESULTS" | wc -l) results" || { echo "Found 0 results"; exit; }
			echo "$RESULTS" |
			while IFS=: read -r FILE_NAME LINE CONTENT; do
				CLEANED_CONTENT=$(echo "$CONTENT" | sed "s/://g")
				echo "$CLEANED_CONTENT:$LINE:$(basename "$FILE_NAME")"
			done
		fi)' \
	--border --layout=reverse --no-info --preview-window=down:$PREVIEW_SIZE:noinfo:wrap --ignore-case --header-lines=1 --prompt="Search: " \
	--preview 'IFS=":" read -r CONTENT LINE FILE_NAME <<< {}
		[[ -z {q} ]] && exit
		if ! [[ -z {} ]]; then
			MAX_LINES=$(wc -l < '$FUZPAD_DIR'/$FILE_NAME)
			START_LINE=$(($LINE > '$START_LINE_SEARCH_PREVIEW' ? $LINE - '$START_LINE_SEARCH_PREVIEW' : 1))
			END_LINE=$(($LINE + 5 < '$END_LINE_SEARCH_PREVIEW' ? $LINE + '$END_LINE_SEARCH_PREVIEW' : MAX_LINES));
			echo -e "\e[1m$FILE_NAME\e[0m"
			echo
			bat --color=always --theme='$BAT_THEME' --style=plain --paging=always --highlight-line=$LINE --line-range $START_LINE:$END_LINE '$FUZPAD_DIR'/$FILE_NAME
		fi')
        
	if [[ -n "$SELECTED" ]]; then
		IFS=":" read -r CONTENT LINE FILE_NAME <<< $SELECTED
		cd "$FUZPAD_DIR"
		${EDITOR} +$LINE "./$FILE_NAME"
	fi
}

show_menu
