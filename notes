#!/bin/bash

# Default directory to scan (change to your default directory if needed)
dir="$HOME/.notes"
actions=("New" "Open" "Search" "Delete" "Quit")
current_date_time=$(date +"%d-%m-%Y-%H-%M-%S")
text_format="txt"
editor="${EDITOR:-nano}"
bat_theme="OneHalfLight"

trap "exit" SIGINT SIGTERM

menu() {
	while true; do
		action=$(printf "%s\n" "${actions[@]}" | fzf --height=20% --border --layout=reverse --prompt="Choose an action: ")	
 		if [[ $? != 0 ]]; then
		  break
    fi
		case $action in
			"New")
				new
				;;
			"Open")
				open
				;;
			"Search")
				search
				;;
			"Delete")
				delete
				;;
			"Quit")
				break
				;;
			*)
				echo "Invalid action"
				;;
		esac
	done
}

new(){
	${editor} "$dir/$current_date_time.$text_format"
}

open(){
	note=$(find "$dir" -type f -name "*.$text_format" | xargs -I {} basename {} | fzf --border --layout=reverse --ignore-case --prompt="Open: " \
	--preview-window=down:80%:noinfo:wrap --preview="bat --color=always --theme=$bat_theme --style=plain $dir/{}")
	
	if [[ -n "$note" ]]; then
		${editor} "$dir/$note"
	fi
}

delete(){
	notes=$(find "$dir" -type f -name "*.$text_format" | xargs -I {} basename {} | fzf --border --layout=reverse --multi --ignore-case --prompt="Delete: " \
	--preview-window=down:80%:noinfo:wrap --preview="bat --color=always --theme=$bat_theme --style=plain $dir/{}")
	
	if [[ -n "$notes" ]]; then
		for note in $notes; do
			rm "$dir/$note"
		done
	fi
}

search(){
	selected=$(echo "Enter your query to begin searching"| fzf --bind 'change:reload(
		max_count=2
		if [[ -z {q} ]]; then
        echo "Enter your query to begin searching"
    else
			echo Found $(grep -rni --include="*."'$text_format' {q} '$dir' 2> /dev/null | wc -l) results
			grep -rni --include="*."'$text_format' {q} '$dir' 2> /dev/null |
			while IFS=: read -r file line content; do
			  cleaned_content=$(echo "$content" | sed "s/://g")
			  echo "$cleaned_content:$line:$(basename "$file")"
			done
		fi
	)' --border --layout=reverse --no-info --preview-window=down:80%:noinfo:wrap --ignore-case --header-lines=1 --prompt="Search: " \
	--preview 'IFS=":" read -r content line filename <<< {}
		[[ -z {q} ]] && exit
		if ! [[ -z {} ]]; then
		 	maxlines=$(wc -l < '$dir'/$filename)
		 	start_line=$(($line > 5 ? $line - 5 : 1))
		 	end_line=$(($line + 5 < maxlines ? $line + 5 : maxlines));
			echo -e "\e[1m$filename\e[0m"
			echo
			bat --color=always --theme='$bat_theme' --style=plain --paging=always --highlight-line=$line --line-range $start_line:$end_line '$dir'/$filename
		fi')
		
	if [[ -n "$selected" ]]; then
		IFS=":" read -r content line filename <<< $selected
		${editor} +$line "$dir/$filename"
	fi
}

menu
